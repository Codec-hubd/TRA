<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Exam Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .view-hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #chat-container {
            transition: transform 0.3s ease-in-out;
        }
        #chat-container.closed {
            transform: translateX(100%);
        }
         .notification-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        textarea {
            resize: none;
            overflow-y: hidden;
        }
        .correct-answer-section {
            display: block;
        }
        .correct-answer-section.hidden {
            display: none;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Auth View Container -->
        <div id="auth-view">
            <!-- Login Form -->
            <div id="login-form">
                <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto mt-20">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2 text-center">Login</h1>
                    <p class="text-gray-500 mb-8 text-center">Welcome back to the Exam Platform.</p>
                    <input type="email" id="login-email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <p id="login-error" class="text-red-500 text-sm text-center min-h-[1.25rem] mb-2"></p>
                    <button id="login-button" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-md">Login</button>
                    <p class="text-center text-sm text-gray-600 mt-4">
                        Don't have an account? <a href="javascript:void(0)" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Sign Up</a>
                    </p>
                </div>
            </div>
            <!-- Signup Form -->
            <div id="signup-form" class="view-hidden">
                <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto mt-20">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2 text-center">Create Account</h1>
                    <p class="text-gray-500 mb-8 text-center">Join the platform to get started.</p>
                    <input type="email" id="signup-email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <p id="signup-error" class="text-red-500 text-sm text-center min-h-[1.25rem] mb-2"></p>
                    <button id="signup-button" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-md">Sign Up</button>
                    <p class="text-center text-sm text-gray-600 mt-4">
                        Already have an account? <a href="javascript:void(0)" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Login</a>
                    </p>
                </div>
            </div>
        </div>


        <!-- App Dashboard View (Post-Login) -->
        <div id="app-dashboard-view" class="view-hidden">
            <header class="flex justify-between items-center mb-8 bg-white p-4 rounded-2xl shadow-md">
                <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                <button id="logout-button" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-600 transition shadow">Logout</button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Side: Create & Join -->
                <div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Join an Exam</h3>
                        <input type="text" id="student-name" placeholder="Enter Your Full Name" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <input type="text" id="exam-code-input" placeholder="Enter 6-Digit Exam Code" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <button id="join-exam-button" class="w-full bg-gray-700 text-white font-semibold py-3 rounded-lg hover:bg-gray-800 transition-transform transform hover:scale-105 shadow-md">Start Exam</button>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Create an Exam</h3>
                        <p class="text-gray-600 mb-4">Design and share your own secure exams.</p>
                        <button id="create-exam-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                            Create New Exam
                        </button>
                    </div>
                </div>

                <!-- Right Side: My Exams -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">My Created Exams</h3>
                    <div id="exam-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Exam cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
       
        <!-- Exam Editor View -->
        <div id="exam-editor-view" class="view-hidden bg-white p-8 rounded-2xl shadow-lg">
            <h2 class="text-3xl font-bold mb-6 text-gray-800" id="editor-heading">Create New Exam</h2>
            <input type="text" id="exam-title" placeholder="Enter Exam Title" class="w-full text-2xl p-3 border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none rounded-t-lg mb-6 transition">
            <div class="flex items-center mb-8">
                 <label for="time-limit" class="mr-4 text-lg font-medium text-gray-700">Time Limit (minutes):</label>
                 <input type="number" id="time-limit" value="60" min="1" class="w-32 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>

            <div id="questions-container" class="space-y-6"></div>
           
            <div class="mt-8 border-t pt-6">
                <h4 class="font-medium text-lg mb-4">Add Question:</h4>
                <div id="add-question-buttons" class="flex flex-wrap items-center gap-3">
                    <button data-type="mcq" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition shadow">Multiple Choice</button>
                    <button data-type="multiple-response" class="bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-600 transition shadow">Multiple Response</button>
                    <button data-type="true-false" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition shadow">True / False</button>
                    <button data-type="numeric" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-600 transition shadow">Numeric Answer</button>
                    <button data-type="fill-blank" class="bg-pink-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-pink-600 transition shadow">Fill-in-the-Blank</button>
                    <button data-type="matching" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition shadow">Matching</button>
                    <button data-type="short" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition shadow">Short Answer</button>
                    <button data-type="long" class="bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-600 transition shadow">Long Answer</button>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button id="cancel-exam-button" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button id="save-exam-button" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 shadow-lg">Save Exam</button>
            </div>
        </div>
       
        <!-- Exam Taking View -->
        <div id="exam-taking-view" class="view-hidden relative">
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-6">
                    <div>
                        <h2 id="student-exam-title" class="text-3xl font-bold text-gray-800"></h2>
                        <p id="student-name-display" class="text-gray-600 text-lg"></p>
                    </div>
                    <div id="timer" class="text-2xl font-bold text-red-500 bg-red-100 px-4 py-2 rounded-lg mt-4 sm:mt-0"></div>
                </div>
                <div id="student-questions-container" class="space-y-8"></div>
                <div class="mt-8 flex justify-end border-t pt-6">
                    <button id="submit-exam-button" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 shadow-lg">Submit Exam</button>
                </div>
            </div>
        </div>
       
        <!-- Collapsible Chat -->
        <div id="chat-wrapper" class="view-hidden">
            <button id="chat-tab" class="fixed right-0 top-1/2 -translate-y-1/2 bg-blue-600 text-white p-3 rounded-l-lg shadow-lg flex items-center gap-2 transition-transform transform hover:bg-blue-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.874 8.874 0 01-4.445-1.242l-2.53 1.265a.5.5 0 01-.65-.65l1.265-2.53A8.874 8.874 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.704 14.125A6.979 6.979 0 0010 15c2.757 0 5-1.79 5-4s-2.243-4-5-4-5 1.79-5 4a6.979 6.979 0 001.296 3.433l-1.07 1.07.707.707 1.07-1.07z" clip-rule="evenodd" /></svg>
                 <span class="font-semibold">Chat</span>
                 <span id="chat-notification" class="absolute -top-1 -left-1 h-4 w-4 bg-red-500 rounded-full view-hidden"></span>
            </button>
            <div id="chat-container" class="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl border-l flex flex-col z-50 closed">
                <div class="bg-gray-800 text-white p-4 flex-shrink-0 flex justify-between items-center">
                    <h3 class="font-bold text-lg">Chat with Instructor</h3>
                    <button id="chat-close-button" class="text-gray-300 hover:text-white text-3xl font-bold leading-none w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-700 transition">&times;</button>
                </div>
                <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto bg-gray-50">
                    <!-- Messages will appear here -->
                </div>
                <div class="p-3 border-t flex-shrink-0 flex gap-2 bg-white">
                    <input type="text" id="chat-input" placeholder="Type your message..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <button id="send-chat-button" class="bg-blue-600 text-white font-semibold px-4 rounded-lg hover:bg-blue-700 transition">Send</button>
                </div>
            </div>
        </div>


        <!-- Student Results View -->
        <div id="results-view" class="view-hidden">
             <div class="bg-white p-8 rounded-2xl shadow-lg max-w-4xl mx-auto mt-10">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Exam Results</h2>
                <p id="results-summary" class="text-xl text-center text-gray-600 mb-8 font-medium"></p>
                <div id="results-loader" class="view-hidden"><div class="loader"></div><p class="text-center text-gray-600">Grading your exam...</p></div>
                <div id="results-details-container" class="space-y-6">
                    <!-- Detailed results will be shown here -->
                </div>
                <div class="text-center mt-8">
                    <button id="results-back-button" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow">Back to Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Teacher Results View (List of Submissions) -->
        <div id="teacher-results-view" class="view-hidden">
             <div class="bg-white p-8 rounded-2xl shadow-lg max-w-4xl mx-auto mt-10">
                <h2 id="teacher-results-heading" class="text-3xl font-bold text-gray-800 mb-6">Submissions</h2>
                <div id="submission-list" class="space-y-4">
                    <!-- Submission list will be shown here -->
                </div>
                <div class="text-center mt-8">
                    <button id="teacher-results-back-button" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-400 transition">Back to Dashboard</button>
                </div>
            </div>
        </div>
       
        <!-- Manual Grading View -->
        <div id="manual-grading-view" class="view-hidden">
            <div class="bg-white p-8 rounded-2xl shadow-lg max-w-4xl mx-auto mt-10">
                <h2 id="manual-grading-heading" class="text-3xl font-bold text-gray-800 mb-2">Grade Submission</h2>
                <p id="manual-grading-summary" class="text-lg text-gray-600 mb-6"></p>
                <div id="manual-grading-container" class="space-y-6">
                    <!-- Questions to grade will be shown here -->
                </div>
                <div class="text-center mt-8">
                    <button id="grading-back-button" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-400 transition">Back to Submissions</button>
                </div>
            </div>
        </div>

       
        <!-- Teacher Chat View -->
        <div id="teacher-chat-view" class="view-hidden">
            <div class="bg-white p-8 rounded-2xl shadow-lg max-w-6xl mx-auto mt-10">
                <h2 id="teacher-chat-heading" class="text-3xl font-bold text-gray-800 mb-6">Live Chat & Announcements</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Student List -->
                    <div class="md:col-span-1 border-r pr-4">
                        <h3 class="font-semibold text-xl mb-3">Students</h3>
                        <div id="chat-student-list" class="space-y-2 max-h-[60vh] overflow-y-auto">
                            <!-- Student list items will appear here -->
                        </div>
                    </div>

                    <!-- Chat Panel -->
                    <div class="md:col-span-2 flex flex-col">
                        <div id="teacher-chat-panel" class="flex-1 p-4 border rounded-lg bg-gray-50 h-[50vh] overflow-y-auto mb-4 flex flex-col space-y-4">
                            <p class="text-gray-500 text-center m-auto">Select a student to view their chat history.</p>
                        </div>
                        <div id="teacher-reply-area" class="view-hidden flex gap-2">
                            <input type="text" id="teacher-chat-input" placeholder="Reply to student..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <button id="teacher-send-reply-button" class="bg-blue-600 text-white font-semibold px-5 rounded-lg hover:bg-blue-700 transition">Send</button>
                        </div>
                    </div>
                </div>
                <!-- Announcements -->
                <div class="mt-8 border-t pt-6">
                     <h3 class="font-semibold text-xl mb-3">Send Announcement to All Students</h3>
                     <div class="flex gap-2">
                        <input type="text" id="announcement-input" placeholder="Type announcement here..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none">
                        <button id="send-announcement-button" class="bg-green-600 text-white font-semibold px-5 rounded-lg hover:bg-green-700 transition">Broadcast</button>
                     </div>
                </div>
                <div class="text-center mt-8">
                    <button id="teacher-chat-back-button" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-400 transition">Back to Dashboard</button>
                </div>
            </div>
        </div>
    </div>
   
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBWrHiR-IDa9RVAybVJ-UVEn5Hx9_qBWX4",
            authDomain: "exam-5e0cd.firebaseapp.com",
            projectId: "exam-5e0cd",
            storageBucket: "exam-5e0cd.appspot.com",
            messagingSenderId: "903148128941",
            appId: "1:903148128941:web:530b620c3e91dddec19424"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let currentExamId = null;
        let examTimerInterval = null;
        let chatUnsubscribe = null;
        let activeTeacherChatExamId = null;
        let activeTeacherChatStudentId = null;
        let allChatMessages = [];
        let lastMessageTimestamp = null;


        // --- UI Navigation ---
        const showView = (viewId) => {
            document.querySelectorAll('#app > div').forEach(div => div.classList.add('view-hidden'));
            document.getElementById(viewId).classList.remove('view-hidden');
           
            // Show/hide chat based on view
            if (viewId === 'exam-taking-view') {
                document.getElementById('chat-wrapper').classList.remove('view-hidden');
            } else {
                document.getElementById('chat-wrapper').classList.add('view-hidden');
            }
        };
       
        const toggleAuthView = (formToShow) => {
            if (formToShow === 'signup') {
                document.getElementById('login-form').classList.add('view-hidden');
                document.getElementById('signup-form').classList.remove('view-hidden');
            } else {
                document.getElementById('login-form').classList.remove('view-hidden');
                document.getElementById('signup-form').classList.add('view-hidden');
            }
        };
       
        // --- Authentication ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showView('app-dashboard-view');
                loadExams();
            } else {
                currentUser = null;
                showView('auth-view');
                toggleAuthView('login');
            }
        });

        const handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const buttonEl = document.getElementById('login-button');

            errorEl.textContent = '';
            if (!email || !password) {
                errorEl.textContent = "Please enter email and password.";
                return;
            }

            buttonEl.disabled = true;
            buttonEl.textContent = 'Processing...';

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("Login Error:", error.code);
                errorEl.textContent = 'Invalid email or password.';
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = 'Login';
            }
        };

        const handleSignup = async () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');
            const buttonEl = document.getElementById('signup-button');

            errorEl.textContent = '';
            if (!email || !password) {
                errorEl.textContent = "Please enter email and password.";
                return;
            }
            if (password.length < 6) {
                errorEl.textContent = "Password should be at least 6 characters.";
                return;
            }

            buttonEl.disabled = true;
            buttonEl.textContent = 'Processing...';

            try {
                await auth.createUserWithEmailAndPassword(email, password);
            } catch (error) {
                 console.error("Signup Error:", error.code);
                if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = 'This email address is already in use.';
                } else {
                    errorEl.textContent = 'Signup failed. Please try again.';
                }
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = 'Sign Up';
            }
        };
       
        const logout = () => {
            auth.signOut();
            localStorage.clear();
            if(examTimerInterval) clearInterval(examTimerInterval);
            if(chatUnsubscribe) chatUnsubscribe();
        };

        const deleteExam = async (examId) => {
             if (!confirm("Are you sure you want to delete this exam and all its data? This action cannot be undone.")) return;
            try {
                const subcollections = ["submissions", "chat"];
                for (const sub of subcollections) {
                    const subCollectionQuery = db.collection("exams").doc(examId).collection(sub);
                    const subCollectionSnapshot = await subCollectionQuery.get();
                    const deletePromises = [];
                    subCollectionSnapshot.forEach((doc) => {
                        deletePromises.push(doc.ref.delete());
                    });
                    await Promise.all(deletePromises);
                }
                await db.collection("exams").doc(examId).delete();
                loadExams();
            } catch (error) {
                console.error("Error deleting exam and its subcollections: ", error);
            }
        };

        // --- Main Dashboard ---
        async function loadExams() {
            if (!currentUser) return;
            const q = db.collection("exams").where("creatorId", "==", currentUser.uid);
            const querySnapshot = await q.get();
            const examList = document.getElementById('exam-list');
            examList.innerHTML = '';
            if(querySnapshot.empty){
                examList.innerHTML = `<p class="text-gray-500">You haven't created any exams yet.</p>`;
                return;
            }
            querySnapshot.forEach((doc) => {
                const exam = doc.data();
                const examCard = `
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-gray-800">${exam.title}</h4>
                            <p class="text-sm text-gray-600">Code: <span class="font-mono bg-gray-300 text-gray-800 px-2 py-0.5 rounded">${doc.id}</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2" data-exam-id="${doc.id}">
                           <button data-action="edit" class="bg-yellow-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-yellow-600 transition text-sm">Edit</button>
                           <button data-action="results" class="bg-teal-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-teal-600 transition text-sm">Results</button>
                           <button data-action="chat" class="bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-600 transition text-sm">Live Chat</button>
                           <button data-action="delete" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-600 transition text-sm">Delete</button>
                        </div>
                    </div>`;
                examList.innerHTML += examCard;
            });
        }
       
        const showExamEditor = async (examId = null) => {
            currentExamId = examId;
            document.getElementById('exam-title').value = '';
            document.getElementById('time-limit').value = 60;
            document.getElementById('questions-container').innerHTML = '';
            const heading = document.getElementById('editor-heading');
            questionIdCounter = 0;

            if (examId) {
                heading.innerText = 'Edit Exam';
                const docRef = db.collection("exams").doc(examId);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const exam = docSnap.data();
                    document.getElementById('exam-title').value = exam.title;
                    document.getElementById('time-limit').value = exam.timeLimit || 60;
                    exam.questions.forEach((q) => addQuestion(q.type, q));
                }
            } else {
                 heading.innerText = 'Create New Exam';
            }
            showView('exam-editor-view');
        };

        const editExam = (examId) => showExamEditor(examId);
       
        // --- Exam Editor ---
        let questionIdCounter = 0;
        function generateExamCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        const addMatchingPair = (questionId) => {
            const container = document.querySelector(`#${questionId} .matching-container`);
            const pairIndex = container.querySelectorAll('.matching-pair').length;
            const newPairHTML = `
                <div class="matching-pair grid grid-cols-2 gap-4 mt-2">
                    <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Prompt ${pairIndex + 1}">
                    <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Answer ${pairIndex + 1}">
                </div>`;
            container.insertAdjacentHTML('beforeend', newPairHTML);
        };
        window.addMatchingPair = addMatchingPair;

        const addQuestion = (type, data = null) => {
            const container = document.getElementById('questions-container');
            const questionId = `q-${questionIdCounter++}`;
            const questionIndex = container.children.length + 1;
            let questionHTML = `
                <div id="${questionId}" class="p-6 border rounded-xl bg-gray-50 relative" data-type="${type}">
                    <button onclick="this.parentElement.remove()" class="absolute top-3 right-3 text-red-500 hover:text-red-700 font-bold p-1 rounded-full text-2xl leading-none">&times;</button>
                    <div class="flex justify-between items-center mb-4">
                         <div class="flex items-center gap-4">
                            <label class="block text-lg font-semibold text-gray-700">Question ${questionIndex}</label>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-600">
                                <input type="checkbox" class="manual-grade-check h-4 w-4 rounded accent-blue-600" ${data && data.manualGrading ? 'checked' : ''}>
                                Manual Grading
                            </label>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="font-medium text-gray-700">Points:</label>
                            <input type="number" value="${data ? data.points : 10}" min="1" class="w-20 p-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <textarea rows="1" class="w-full p-2 border border-gray-300 rounded-lg mb-4 text-lg focus:ring-2 focus:ring-blue-400" placeholder="Enter question text...">${data ? data.text : ''}</textarea>`;

            const isManual = data && data.manualGrading;
            const correctAnsSectionVisibility = isManual ? 'hidden' : '';

            switch (type) {
                case 'mcq':
                    questionHTML += `<div class="space-y-2 options-container correct-answer-section ${correctAnsSectionVisibility}">`;
                    const options = data ? data.options : ['', '', '', ''];
                    options.forEach((opt, i) => {
                        questionHTML += `
                            <div class="flex items-center">
                                <input type="radio" name="correct-${questionId}" value="${i}" class="mr-3 h-5 w-5 accent-blue-600" ${data && data.correctAnswer == i ? 'checked' : ''}>
                                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-400" placeholder="Option ${i+1}" value="${opt}">
                            </div>`;
                    });
                    questionHTML += '</div>';
                    break;
                case 'multiple-response':
                     questionHTML += `<div class="space-y-2 options-container correct-answer-section ${correctAnsSectionVisibility}">`;
                    const mr_options = data ? data.options : ['', '', '', ''];
                    const correct_mr_answers = data ? data.correctAnswers : [];
                    mr_options.forEach((opt, i) => {
                        questionHTML += `
                            <div class="flex items-center">
                                <input type="checkbox" name="correct-${questionId}" value="${i}" class="mr-3 h-5 w-5 accent-cyan-600" ${correct_mr_answers.includes(i) ? 'checked' : ''}>
                                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-cyan-400" placeholder="Option ${i+1}" value="${opt}">
                            </div>`;
                    });
                    questionHTML += '</div><p class="text-sm text-gray-500 mt-2 correct-answer-section">Check all correct answers.</p>';
                    break;
                case 'true-false':
                    const tf_correct = data ? data.correctAnswer : true;
                    questionHTML += `<div class="flex space-x-6 text-lg correct-answer-section ${correctAnsSectionVisibility}">
                        <label class="flex items-center"><input type="radio" name="correct-${questionId}" value="true" class="mr-2 h-5 w-5 accent-green-600" ${tf_correct === true ? 'checked' : ''}> True</label>
                        <label class="flex items-center"><input type="radio" name="correct-${questionId}" value="false" class="mr-2 h-5 w-5 accent-red-600" ${tf_correct === false ? 'checked' : ''}> False</label>
                    </div>`;
                    break;
                case 'numeric':
                    questionHTML += `<div class="flex items-center gap-4 correct-answer-section ${correctAnsSectionVisibility}">
                        <label class="font-medium">Correct Answer:</label>
                        <input type="number" class="numeric-answer w-32 p-2 border border-gray-300 rounded-lg" placeholder="e.g. 42" value="${data ? data.correctAnswer : ''}">
                        <label class="font-medium">Tolerance (+/-):</label>
                        <input type="number" class="numeric-tolerance w-32 p-2 border border-gray-300 rounded-lg" placeholder="e.g. 0.5" value="${data ? data.tolerance : ''}">
                    </div>`;
                    break;
                case 'fill-blank':
                    const blanks = data ? data.blanks.join(', ') : '';
                    questionHTML += `<div class="space-y-2 correct-answer-section ${correctAnsSectionVisibility}">
                        <p class="text-sm text-gray-600">In the question text above, use <code>[blank]</code> for each word you want the student to fill in.</p>
                        <label class="font-medium">Correct words for blanks (in order, comma-separated):</label>
                        <input type="text" class="fill-blank-answers w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g. blue, green" value="${blanks}">
                    </div>`;
                    break;
                case 'matching':
                    questionHTML += `<div class="matching-container space-y-2 correct-answer-section ${correctAnsSectionVisibility}">
                        <div class="grid grid-cols-2 gap-4 font-medium">
                            <span>Prompt</span>
                            <span>Correctly Matched Answer</span>
                        </div>
                    `;
                    const pairs = data ? data.pairs : [{prompt: '', answer: ''}, {prompt: '', answer: ''}];
                    pairs.forEach((pair, index) => {
                        questionHTML += `
                            <div class="matching-pair grid grid-cols-2 gap-4">
                                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Prompt ${index + 1}" value="${pair.prompt}">
                                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Answer ${index + 1}" value="${pair.answer}">
                            </div>`;
                    });
                    questionHTML += `</div><button type="button" onclick="addMatchingPair('${questionId}')" class="mt-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded correct-answer-section ${correctAnsSectionVisibility}">Add Pair</button>`;
                    break;
                case 'short': case 'long':
                     questionHTML += `<div class="p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-r-lg text-sm">Graded by AI by default. Check "Manual Grading" to override.</div>`;
                    break;
            }
            questionHTML += '</div>';
            container.insertAdjacentHTML('beforeend', questionHTML);
        };
       
        const saveExam = async () => {
            const title = document.getElementById('exam-title').value;
            const timeLimit = parseInt(document.getElementById('time-limit').value, 10);
            if (!title) { alert("Please enter an exam title."); return; }
           
            const questions = [];
            document.querySelectorAll('#questions-container > div').forEach(qDiv => {
                const type = qDiv.dataset.type;
                const manualGradingCheckbox = qDiv.querySelector('.manual-grade-check');
                const isManual = manualGradingCheckbox && manualGradingCheckbox.checked;

                const question = {
                    type: type,
                    text: qDiv.querySelector('textarea').value,
                    points: parseInt(qDiv.querySelector('input[type="number"]').value, 10) || 10,
                    manualGrading: isManual
                };

                if (!isManual) {
                    switch (question.type) {
                        case 'mcq':
                            question.options = Array.from(qDiv.querySelectorAll('.options-container input[type="text"]')).map(opt => opt.value);
                            const correctRadio = qDiv.querySelector('input[type="radio"]:checked');
                            question.correctAnswer = correctRadio ? parseInt(correctRadio.value, 10) : -1;
                            break;
                        case 'multiple-response':
                            question.options = Array.from(qDiv.querySelectorAll('.options-container input[type="text"]')).map(opt => opt.value);
                            question.correctAnswers = Array.from(qDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.value, 10));
                            break;
                        case 'true-false':
                            const tfRadio = qDiv.querySelector('input[type="radio"]:checked');
                            question.correctAnswer = tfRadio ? (tfRadio.value === 'true') : null;
                            break;
                        case 'numeric':
                            question.correctAnswer = parseFloat(qDiv.querySelector('.numeric-answer').value);
                            question.tolerance = parseFloat(qDiv.querySelector('.numeric-tolerance').value) || 0;
                            break;
                        case 'fill-blank':
                            question.blanks = qDiv.querySelector('.fill-blank-answers').value.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
                            break;
                        case 'matching':
                            question.pairs = [];
                            qDiv.querySelectorAll('.matching-pair').forEach(pairEl => {
                                const inputs = pairEl.querySelectorAll('input[type="text"]');
                                if (inputs[0].value && inputs[1].value) {
                                    question.pairs.push({ prompt: inputs[0].value, answer: inputs[1].value });
                                }
                            });
                            break;
                    }
                }
                questions.push(question);
            });

            if(questions.length === 0){ alert("Please add at least one question."); return; }

            const examData = { title, timeLimit, questions, creatorId: currentUser.uid };
            if (currentExamId) {
                await db.collection("exams").doc(currentExamId).set(examData);
            } else {
                const newExamCode = generateExamCode();
                await db.collection("exams").doc(newExamCode).set(examData);
            }
            showView('app-dashboard-view');
            loadExams();
        };

        // --- Student Flow ---
        const joinExam = async () => {
            const examCode = document.getElementById('exam-code-input').value.trim().toUpperCase();
            const studentName = document.getElementById('student-name').value.trim();
            if (!examCode || !studentName) { alert("Please enter your name and an exam code."); return; }

            const docRef = db.collection("exams").doc(examCode);
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                const studentId = `${studentName.replace(/\s+/g, '-')}-${uuid.v4()}`;
                localStorage.setItem('currentStudentId', studentId);
                localStorage.setItem('currentExamCode', examCode);
                localStorage.setItem('currentStudentName', studentName);
                const exam = docSnap.data();
                localStorage.setItem('currentExamData', JSON.stringify(exam));

                document.getElementById('student-exam-title').innerText = exam.title;
                document.getElementById('student-name-display').innerText = `Student: ${studentName}`;
               
                document.getElementById('chat-container').classList.add('closed');
               
                const questionsContainer = document.getElementById('student-questions-container');
                questionsContainer.innerHTML = '';
                exam.questions.forEach((q, index) => {
                    let questionHTML = `<div class="p-4 rounded-lg bg-gray-50" data-index="${index}" data-type="${q.type}"><p class="text-xl font-semibold mb-4 text-gray-800">${index + 1}. ${q.text} <span class="text-base font-normal text-gray-500">(${q.points} points)</span></p>`;
                    switch (q.type) {
                        case 'mcq':
                            questionHTML += `<div class="space-y-3">`;
                            q.options.forEach((opt, i) => {
                                questionHTML += `<label class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer"><input type="radio" name="answer-${index}" value="${i}" class="h-5 w-5 mr-4 accent-blue-600"><span class="text-gray-700">${opt}</span></label>`;
                            });
                            questionHTML += `</div>`;
                            break;
                        case 'multiple-response':
                            questionHTML += `<div class="space-y-3">`;
                            q.options.forEach((opt, i) => {
                                questionHTML += `<label class="flex items-center p-3 border rounded-lg hover:bg-cyan-50 cursor-pointer"><input type="checkbox" name="answer-${index}" value="${i}" class="h-5 w-5 mr-4 accent-cyan-600"><span class="text-gray-700">${opt}</span></label>`;
                            });
                            questionHTML += `</div>`;
                            break;
                        case 'true-false':
                            questionHTML += `<div class="space-y-3">`;
                            questionHTML += `<label class="flex items-center p-3 border rounded-lg hover:bg-green-50 cursor-pointer"><input type="radio" name="answer-${index}" value="true" class="h-5 w-5 mr-4 accent-green-600"><span class="text-gray-700">True</span></label>`;
                            questionHTML += `<label class="flex items-center p-3 border rounded-lg hover:bg-red-50 cursor-pointer"><input type="radio" name="answer-${index}" value="false" class="h-5 w-5 mr-4 accent-red-600"><span class="text-gray-700">False</span></label>`;
                            questionHTML += `</div>`;
                            break;
                        case 'numeric':
                            questionHTML += `<input type="number" step="any" placeholder="Enter numeric answer..." class="w-full sm:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">`;
                            break;
                        case 'fill-blank':
                            const blankedText = q.text.replace(/\[blank\]/g, () => `<input type="text" class="inline-block w-40 p-1 mx-1 border-b-2 border-gray-400 focus:border-pink-500 focus:outline-none bg-transparent">`);
                            questionHTML += `<div class="text-xl leading-loose">${blankedText}</div>`;
                            break;
                        case 'matching':
                            const prompts = q.pairs.map(p => p.prompt);
                            const answers = [...q.pairs.map(p => p.answer)].sort(() => Math.random() - 0.5);
                            questionHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">`;
                            prompts.forEach((prompt, i) => {
                                questionHTML += `
                                    <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg">
                                        <span class="font-medium text-gray-800">${prompt}</span>
                                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                                            <option value="">Select a match...</option>
                                            ${answers.map(ans => `<option value="${ans}">${ans}</option>`).join('')}
                                        </select>
                                    </div>
                                `;
                            });
                            questionHTML += `</div>`;
                            break;
                        case 'short':
                            questionHTML += `<textarea rows="1" placeholder="Your answer..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>`;
                            break;
                        case 'long':
                            questionHTML += `<textarea rows="1" placeholder="Your detailed answer..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>`;
                            break;
                    }
                    questionHTML += `</div>`;
                    questionsContainer.innerHTML += questionHTML;
                });
                startTimer(exam.timeLimit);
                startChatListener(examCode, studentId);
                showView('exam-taking-view');
            } else {
                alert("Invalid exam code.");
            }
        };

        function startTimer(minutes) {
            let seconds = minutes * 60;
            const timerEl = document.getElementById('timer');
            if (examTimerInterval) clearInterval(examTimerInterval);
            examTimerInterval = setInterval(() => {
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                timerEl.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                seconds--;
                if (seconds < 0) {
                    clearInterval(examTimerInterval);
                    submitExam();
                }
            }, 1000);
        }

        async function evaluateWithAI(question, answer) {
            const pipedreamUrl = "https://eost4t92gmnlal8.m.pipedream.net";
            const fullPrompt = `The following is a question from an exam and a student's answer to it. Question: "${question}". Student's Answer: "${answer}". Please act as an AI grader. Evaluate the student's answer based on the question. Provide a score from 0.0 (completely incorrect) to 1.0 (perfectly correct). Also, provide brief, constructive feedback. Your response MUST be ONLY a valid JSON object in the format: {"score": <number>, "feedback": "<string>"}. Do not include any other text, greetings, or explanations outside of the JSON object.`;
           
            try {
                const response = await fetch(pipedreamUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: fullPrompt, answer: answer })
                });

                const responseText = await response.text();
                if (!response.ok) {
                    console.error("Pipedream request failed with status:", response.status);
                    throw new Error("Failed to get a valid response from the grading service.");
                }
               
                const jsonMatch = responseText.match(/\{.*\}/s);
                if (jsonMatch && jsonMatch[0]) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    console.error("No JSON object found in Pipedream response:", responseText);
                    throw new Error("No JSON object found in the AI response.");
                }

            } catch (error) {
                console.error("The AI grading function failed:", error);
                return { score: 0, feedback: "AI grading failed. Please check the console." };
            }
        }
       
        const submitExam = async () => {
            if(examTimerInterval) clearInterval(examTimerInterval);
            if(chatUnsubscribe) chatUnsubscribe();

            document.getElementById('chat-wrapper').classList.add('view-hidden');
           
            showView('results-view');
            document.getElementById('results-loader').classList.remove('view-hidden');
            document.getElementById('results-details-container').innerHTML = '';
            document.getElementById('results-summary').innerText = '';

            const examData = JSON.parse(localStorage.getItem('currentExamData'));
            const studentId = localStorage.getItem('currentStudentId');
            const studentName = localStorage.getItem('currentStudentName');

            const submissionAnswers = [];
            const gradingPromises = examData.questions.map((question, i) => {
                const qDiv = document.querySelector(`#student-questions-container > div[data-index="${i}"]`);
                let studentAnswer;
                switch(question.type) {
                    case 'mcq':
                        const checkedRadio = qDiv.querySelector('input[type="radio"]:checked');
                        studentAnswer = checkedRadio ? parseInt(checkedRadio.value, 10) : null;
                        break;
                    case 'multiple-response':
                        studentAnswer = Array.from(qDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.value, 10));
                        break;
                    case 'true-false':
                        const tfCheckedRadio = qDiv.querySelector('input[type="radio"]:checked');
                        studentAnswer = tfCheckedRadio ? (tfCheckedRadio.value === 'true') : null;
                        break;
                    case 'numeric':
                        const numInput = qDiv.querySelector('input[type="number"]');
                        studentAnswer = numInput.value !== '' ? parseFloat(numInput.value) : null;
                        break;
                    case 'fill-blank':
                        studentAnswer = Array.from(qDiv.querySelectorAll('input[type="text"]')).map(inp => inp.value.trim());
                        break;
                    case 'matching':
                        studentAnswer = Array.from(qDiv.querySelectorAll('select')).map(select => select.value);
                        break;
                    case 'short':
                    case 'long':
                        studentAnswer = qDiv.querySelector('textarea').value;
                        break;
                }
               
                const answerData = {
                    questionText: question.text,
                    studentAnswer: studentAnswer,
                    maxPoints: question.points,
                    isManual: question.manualGrading
                };

                if (question.manualGrading) {
                    answerData.score = null;
                    answerData.feedback = 'Pending manual grading';
                    submissionAnswers[i] = answerData;
                    return Promise.resolve();
                } else if (question.type === 'short' || question.type === 'long') {
                    return evaluateWithAI(question.text, studentAnswer || "").then(aiResult => {
                        answerData.score = aiResult.score * question.points;
                        answerData.feedback = aiResult.feedback;
                        submissionAnswers[i] = answerData;
                    });
                } else {
                    let isCorrect = false;
                    const correctFeedback = 'Correct';
                    let incorrectFeedback = 'Incorrect';

                    switch (question.type) {
                        case 'mcq':
                            isCorrect = studentAnswer === question.correctAnswer;
                            if (!isCorrect && question.options && question.correctAnswer >= 0 && question.options[question.correctAnswer]) {
                                incorrectFeedback = `Incorrect. The correct answer was: ${question.options[question.correctAnswer]}`;
                            }
                            break;
                        case 'true-false':
                            isCorrect = studentAnswer === question.correctAnswer;
                            break;
                        case 'multiple-response':
                            if (studentAnswer && question.correctAnswers) {
                                const correctSet = new Set(question.correctAnswers);
                                const studentSet = new Set(studentAnswer);
                                isCorrect = correctSet.size === studentSet.size && [...correctSet].every(item => studentSet.has(item));
                            }
                            break;
                        case 'numeric':
                             if (studentAnswer !== null) {
                                const tolerance = question.tolerance || 0;
                                isCorrect = Math.abs(studentAnswer - question.correctAnswer) <= tolerance;
                            }
                            break;
                        case 'fill-blank':
                            if (studentAnswer && studentAnswer.length === question.blanks.length) {
                                isCorrect = studentAnswer.every((ans, i) => ans.trim().toLowerCase() === question.blanks[i]);
                            }
                            break;
                        case 'matching':
                             if (studentAnswer && studentAnswer.length === question.pairs.length) {
                                isCorrect = studentAnswer.every((ans, index) => ans === question.pairs[index].answer);
                            }
                            break;
                    }
                    answerData.score = isCorrect ? question.points : 0;
                    answerData.feedback = isCorrect ? correctFeedback : incorrectFeedback;
                    submissionAnswers[i] = answerData;
                    return Promise.resolve();
                }
            });

            await Promise.all(gradingPromises);

            let earnedScore = 0;
            let totalPossibleScore = 0;
            let hasPending = false;
            const resultsDetailsContainer = document.getElementById('results-details-container');
            resultsDetailsContainer.innerHTML = '';

            submissionAnswers.forEach((result, i) => {
                totalPossibleScore += result.maxPoints;
                if (result.score !== null) {
                    earnedScore += result.score;
                } else {
                    hasPending = true;
                }

                let answerDisplay = '';
                if (result.studentAnswer !== null && result.studentAnswer !== undefined) {
                    answerDisplay = Array.isArray(result.studentAnswer) ? result.studentAnswer.join(', ') : result.studentAnswer;
                } else {
                    answerDisplay = "No answer provided";
                }

                const scoreText = result.score !== null ? `${result.score.toFixed(1)} / ${result.maxPoints}` : `Pending / ${result.maxPoints}`;
                const bgColor = result.score === null ? 'bg-yellow-100' : (result.score > 0 ? 'bg-green-100' : 'bg-red-100');
                const textColor = result.score === null ? 'text-yellow-800' : (result.score > 0 ? 'text-green-800' : 'text-red-800');

                const resultCard = `
                    <div class="p-4 border rounded-lg bg-white shadow-sm">
                        <p class="font-semibold text-lg text-gray-800">${i + 1}. ${result.questionText}</p>
                        <p class="mt-2 text-gray-700">Your Answer: <span class="font-medium">${answerDisplay}</span></p>
                        <div class="mt-3 p-3 rounded-lg ${bgColor}">
                            <p class="font-semibold">Score: <span class="${textColor}">${scoreText}</span></p>
                            <p class="text-sm ${textColor}"><em>Feedback: ${result.feedback}</em></p>
                        </div>
                    </div>
                `;
                resultsDetailsContainer.innerHTML += resultCard;
            });

            const percentage = totalPossibleScore > 0 ? ((earnedScore / totalPossibleScore) * 100).toFixed(1) : 0;

            document.getElementById('results-loader').classList.add('view-hidden');
            let summaryText = `You scored ${earnedScore.toFixed(1)} out of ${totalPossibleScore} (${percentage}%)`;
            if (hasPending) {
                summaryText += ". Some questions are pending manual grading.";
            }
            document.getElementById('results-summary').innerText = summaryText;

            const examCode = localStorage.getItem('currentExamCode');
            const submissionData = {
                studentId, studentName,
                answers: submissionAnswers,
                totalScore: earnedScore,
                maxScore: totalPossibleScore,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection("exams").doc(examCode).collection("submissions").doc(studentId).set(submissionData);
        };
       
        const viewResults = async (examId) => {
            currentExamId = examId;
            const examRef = db.collection("exams").doc(examId);
            const examSnap = await examRef.get();
            const examTitle = examSnap.exists ? examSnap.data().title : "Results";
           
            document.getElementById('teacher-results-heading').innerText = `Submissions for: ${examTitle}`;
            showView('teacher-results-view');
            const submissionListEl = document.getElementById('submission-list');
            submissionListEl.innerHTML = '<div class="loader"></div>';

            const submissionsCol = db.collection("exams").doc(examId).collection("submissions");
            const snapshot = await submissionsCol.get();

            if (snapshot.empty) {
                submissionListEl.innerHTML = '<p class="text-gray-500 text-center">No submissions have been made for this exam yet.</p>';
                return;
            }

            submissionListEl.innerHTML = '';
            snapshot.forEach(doc => {
                const sub = doc.data();
                 const percentage = sub.maxScore > 0 ? ((sub.totalScore / sub.maxScore) * 100).toFixed(1) : 0;
                const submissionCard = `
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${sub.studentName}</p>
                                 <p class="text-sm text-gray-500">Submitted on: ${new Date(sub.timestamp?.toDate()).toLocaleString()}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <p class="font-semibold text-blue-600 text-lg">Score: ${sub.totalScore.toFixed(1)} / ${sub.maxScore} (${percentage}%)</p>
                                <button data-submission-id="${doc.id}" class="grade-submission-btn bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition">Grade</button>
                            </div>
                        </div>
                    </div>
                `;
                submissionListEl.innerHTML += submissionCard;
            });
        };
       
        // --- Manual Grading Functions ---
        const gradeStudentSubmission = async (submissionId) => {
            const submissionRef = db.collection("exams").doc(currentExamId).collection("submissions").doc(submissionId);
            const submissionSnap = await submissionRef.get();
            if (!submissionSnap.exists) {
                alert("Submission not found!");
                return;
            }

            const submission = submissionSnap.data();
            const maxScore = submission.maxScore;
            const currentTotal = submission.totalScore;

            document.getElementById('manual-grading-heading').innerText = `Grading: ${submission.studentName}`;
            document.getElementById('manual-grading-summary').innerText = `Current Score: ${currentTotal.toFixed(1)} / ${maxScore}`;

            const container = document.getElementById('manual-grading-container');
            container.innerHTML = '';

            submission.answers.forEach((ans, index) => {
                let answerDisplay = '';
                if (ans.studentAnswer !== null && ans.studentAnswer !== undefined) {
                    answerDisplay = Array.isArray(ans.studentAnswer) ? ans.studentAnswer.join(', ') : ans.studentAnswer;
                } else {
                    answerDisplay = "No answer provided";
                }

                let gradingControls = '';
                if(ans.isManual) {
                     gradingControls = `
                        <div class="mt-3 p-3 rounded-lg bg-yellow-100 flex items-center gap-4">
                            <label class="font-semibold text-yellow-800">Score:</label>
                            <input type="number" value="${ans.score !== null ? ans.score : ''}" min="0" max="${ans.maxPoints}" class="w-24 p-2 border rounded-lg">
                            <span class="text-yellow-800">/ ${ans.maxPoints}</span>
                            <button data-index="${index}" class="save-grade-btn bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-600">Save</button>
                        </div>
                     `;
                } else {
                    gradingControls = `
                         <div class="mt-3 p-3 rounded-lg ${ans.score > 0 ? 'bg-green-100' : 'bg-red-100'}">
                            <p class="font-semibold">Score: <span class="${ans.score > 0 ? 'text-green-800' : 'text-red-800'}">${ans.score.toFixed(1)} / ${ans.maxPoints}</span></p>
                            <p class="text-sm ${ans.score > 0 ? 'text-green-700' : 'text-red-700'}"><em>Feedback: ${ans.feedback}</em></p>
                        </div>
                    `;
                }

                const questionCard = `
                    <div class="p-4 border rounded-lg bg-white shadow-sm">
                        <p class="font-semibold text-lg text-gray-800">${index + 1}. ${ans.questionText}</p>
                        <p class="mt-2 text-gray-700">Student's Answer: <span class="font-medium">${answerDisplay}</span></p>
                        ${gradingControls}
                    </div>
                `;
                container.innerHTML += questionCard;
            });
           
            container.dataset.submissionId = submissionId; // Store for saving
            showView('manual-grading-view');
        };
       
        const saveManualGrade = async (e) => {
             const button = e.target;
            if (!button || !button.classList.contains('save-grade-btn')) return;

            const questionIndex = parseInt(button.dataset.index, 10);
            const scoreInput = button.parentElement.querySelector('input[type="number"]');
            const newScore = parseFloat(scoreInput.value);
            const submissionId = document.getElementById('manual-grading-container').dataset.submissionId;

            const submissionRef = db.collection("exams").doc(currentExamId).collection("submissions").doc(submissionId);
            const submissionSnap = await submissionRef.get();
            const submission = submissionSnap.data();
           
            const maxPoints = submission.answers[questionIndex].maxPoints;

            if (isNaN(newScore) || newScore < 0 || newScore > maxPoints) {
                alert(`Please enter a valid score between 0 and ${maxPoints}.`);
                return;
            }

            submission.answers[questionIndex].score = newScore;
            submission.answers[questionIndex].feedback = `Manually graded.`;

            // Recalculate total score
            let newTotalScore = 0;
            submission.answers.forEach(ans => {
                if(ans.score !== null) {
                    newTotalScore += ans.score;
                }
            });
            submission.totalScore = newTotalScore;

            await submissionRef.update(submission);

            document.getElementById('manual-grading-summary').innerText = `Current Score: ${newTotalScore.toFixed(1)} / ${submission.maxScore}`;
            scoreInput.parentElement.classList.remove('bg-yellow-100');
            scoreInput.parentElement.classList.add('bg-green-100');
            button.textContent = 'Saved!';
            setTimeout(() => button.textContent = 'Save', 2000);
        };


        // --- Chat Functions ---
        const openChat = () => {
            const chatContainer = document.getElementById('chat-container');
            const chatTab = document.getElementById('chat-tab');
            chatContainer.classList.remove('closed');
            chatTab.classList.add('translate-x-full'); // Hide tab when panel is open
             const notificationBadge = document.getElementById('chat-notification');
            notificationBadge.classList.add('view-hidden');
            notificationBadge.classList.remove('notification-pulse');
        };

        const closeChat = () => {
            const chatContainer = document.getElementById('chat-container');
            const chatTab = document.getElementById('chat-tab');
            chatContainer.classList.add('closed');
            chatTab.classList.remove('translate-x-full'); // Show tab when panel is closed
        };

        function renderMessages(containerEl, messages, currentUserId) {
            containerEl.innerHTML = '';
            if (!messages || messages.length === 0) {
                containerEl.innerHTML = '<p class="text-gray-400 text-sm text-center m-auto">No messages yet. Ask a question below.</p>';
                return;
            }
            messages.forEach(msg => {
                const isSender = msg.senderId === currentUserId;
                const msgAlign = isSender ? 'self-end' : 'self-start';
                const msgColor = msg.isAnnouncement ? 'bg-yellow-100 border-l-4 border-yellow-500 p-3 w-full' : (isSender ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800');
               
                const messageHTML = `
                    <div class="flex flex-col ${isSender ? 'items-end' : 'items-start'} w-full">
                        <div class="text-xs text-gray-500 mb-1">${msg.senderName} - ${new Date(msg.timestamp?.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        <div class="max-w-xs p-3 rounded-xl ${msgColor}">${msg.text}</div>
                    </div>`;
                containerEl.innerHTML += messageHTML;
            });
            containerEl.scrollTop = containerEl.scrollHeight;
        }

        async function startChatListener(examId, studentId) {
            if (chatUnsubscribe) chatUnsubscribe();
            lastMessageTimestamp = null; // Reset for new session
            const chatQuery = db.collection("exams").doc(examId).collection("chat");
            chatUnsubscribe = chatQuery.onSnapshot((querySnapshot) => {
                const messages = [];
                let latestTimestamp = null;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    messages.push({ id: doc.id, ...data });
                    if (!latestTimestamp || data.timestamp > latestTimestamp) {
                        latestTimestamp = data.timestamp;
                    }
                });

                const relevantMessages = messages.filter(m => m.isAnnouncement || m.studentId === studentId)
                                                .sort((a,b) => a.timestamp - b.timestamp);
               
                const chatContainer = document.getElementById('chat-messages');
                renderMessages(chatContainer, relevantMessages, studentId);
               
                // Notification logic
                const chatPanel = document.getElementById('chat-container');
                if (chatPanel.classList.contains('closed') && latestTimestamp && latestTimestamp !== lastMessageTimestamp) {
                    const notificationBadge = document.getElementById('chat-notification');
                    notificationBadge.classList.remove('view-hidden');
                    notificationBadge.classList.add('notification-pulse');
                }
                lastMessageTimestamp = latestTimestamp;
            });
        }
       
        const sendStudentMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const examId = localStorage.getItem('currentExamCode');
            const studentId = localStorage.getItem('currentStudentId');
            const studentName = localStorage.getItem('currentStudentName');

            const chatCol = db.collection("exams").doc(examId).collection("chat");
            await chatCol.add({
                text, studentId, senderId: studentId, senderName: studentName, timestamp: firebase.firestore.FieldValue.serverTimestamp(), isAnnouncement: false
            });
            input.value = '';
        };

        const openTeacherChat = (examId) => {
            showView('teacher-chat-view');
            document.getElementById('teacher-chat-panel').innerHTML = '<p class="text-gray-500 text-center m-auto">Select a student to view their chat history.</p>';
            document.getElementById('teacher-reply-area').classList.add('view-hidden');
            activeTeacherChatExamId = examId;

            if (chatUnsubscribe) chatUnsubscribe();
            const chatQuery = db.collection("exams").doc(examId).collection("chat");
            chatUnsubscribe = chatQuery.onSnapshot((snapshot) => {
                allChatMessages = [];
                snapshot.forEach(doc => allChatMessages.push({ id: doc.id, ...doc.data() }));
                allChatMessages.sort((a, b) => a.timestamp - b.timestamp);

                const studentListEl = document.getElementById('chat-student-list');
                const students = {};
                allChatMessages.forEach(msg => {
                    if(msg.studentId && !msg.isAnnouncement) {
                         students[msg.studentId] = { name: 'Loading name...', timestamp: msg.timestamp };
                    }
                });
                allChatMessages.forEach(msg => {
                    if (students[msg.studentId] && msg.senderId === msg.studentId) {
                        students[msg.studentId].name = msg.senderName;
                    }
                });

                studentListEl.innerHTML = '';
                if (Object.keys(students).length === 0) {
                    studentListEl.innerHTML = '<p class="text-gray-500 text-sm">No student chats started.</p>';
                } else {
                    const sortedStudents = Object.entries(students).sort(([,a], [,b]) => b.timestamp - a.timestamp);
                    for (const [id, data] of sortedStudents) {
                         const studentDiv = document.createElement('div');
                         studentDiv.className = `p-2 rounded-lg cursor-pointer hover:bg-gray-200 ${activeTeacherChatStudentId === id ? 'bg-blue-100' : 'bg-gray-100'}`;
                         studentDiv.textContent = data.name || 'Unknown Student';
                         studentDiv.onclick = () => selectStudentForChat(id, data.name);
                         studentListEl.appendChild(studentDiv);
                    }
                }

                if(activeTeacherChatStudentId){
                    selectStudentForChat(activeTeacherChatStudentId, students[activeTeacherChatStudentId]?.name);
                }
            });
        };

        const closeTeacherChat = () => {
            if (chatUnsubscribe) chatUnsubscribe();
            chatUnsubscribe = null;
            activeTeacherChatExamId = null;
            activeTeacherChatStudentId = null;
            allChatMessages = [];
            showView('app-dashboard-view');
        };
       
        const selectStudentForChat = (studentId, studentName) => {
            activeTeacherChatStudentId = studentId;
             if (!studentName) return; // Prevent error if student left
            document.getElementById('teacher-reply-area').classList.remove('view-hidden');
           
            const studentListEl = document.getElementById('chat-student-list');
            studentListEl.querySelectorAll('div').forEach(div => {
                div.classList.remove('bg-blue-100');
                if (div.textContent === studentName) div.classList.add('bg-blue-100');
            });

            const relevantMessages = allChatMessages.filter(m => m.isAnnouncement || m.studentId === studentId);
            const chatContainer = document.getElementById('teacher-chat-panel');
            renderMessages(chatContainer, relevantMessages, currentUser.uid);
        };

        const sendTeacherReply = async () => {
            const input = document.getElementById('teacher-chat-input');
            const text = input.value.trim();
            if (!text || !activeTeacherChatExamId || !activeTeacherChatStudentId) return;

            const chatCol = db.collection("exams").doc(activeTeacherChatExamId).collection("chat");
            await chatCol.add({
                text, studentId: activeTeacherChatStudentId, senderId: currentUser.uid, senderName: "Instructor", timestamp: firebase.firestore.FieldValue.serverTimestamp(), isAnnouncement: false,
            });
            input.value = '';
        };

        const sendAnnouncement = async () => {
            const input = document.getElementById('announcement-input');
            const text = input.value.trim();
            if (!text || !activeTeacherChatExamId) return;

            const chatCol = db.collection("exams").doc(activeTeacherChatExamId).collection("chat");
            await chatCol.add({
                text, senderId: currentUser.uid, senderName: "Instructor (Announcement)", timestamp: firebase.firestore.FieldValue.serverTimestamp(), isAnnouncement: true
            });
            input.value = '';
        };
       
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Auth
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('signup-button').addEventListener('click', handleSignup);
            document.getElementById('show-signup').addEventListener('click', () => toggleAuthView('signup'));
            document.getElementById('show-login').addEventListener('click', () => toggleAuthView('login'));
            document.getElementById('logout-button').addEventListener('click', logout);
           
            // Dashboard
            document.getElementById('join-exam-button').addEventListener('click', joinExam);
            document.getElementById('create-exam-button').addEventListener('click', () => showExamEditor());

            // Exam List (Event Delegation)
            document.getElementById('exam-list').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
               
                const action = button.dataset.action;
                const examId = button.parentElement.dataset.examId;
               
                if (action === 'edit') editExam(examId);
                else if (action === 'results') viewResults(examId);
                else if (action === 'chat') openTeacherChat(examId);
                else if (action === 'delete') deleteExam(examId);
            });
           
            // Exam Editor
            document.getElementById('add-question-buttons').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON' && e.target.dataset.type){
                    addQuestion(e.target.dataset.type);
                }
            });
            document.getElementById('cancel-exam-button').addEventListener('click', () => showView('app-dashboard-view'));
            document.getElementById('save-exam-button').addEventListener('click', saveExam);
            document.getElementById('questions-container').addEventListener('change', (e) => {
                if (e.target.classList.contains('manual-grade-check')) {
                    const questionDiv = e.target.closest('[data-type]');
                    const sections = questionDiv.querySelectorAll('.correct-answer-section');
                    sections.forEach(section => {
                        section.classList.toggle('hidden', e.target.checked);
                    });
                }
            });

            // Exam Taking
            document.getElementById('submit-exam-button').addEventListener('click', submitExam);

            // Results
            document.getElementById('results-back-button').addEventListener('click', () => showView('app-dashboard-view'));
            document.getElementById('teacher-results-back-button').addEventListener('click', () => showView('app-dashboard-view'));
            document.getElementById('submission-list').addEventListener('click', (e) => {
                if(e.target.classList.contains('grade-submission-btn')) {
                    gradeStudentSubmission(e.target.dataset.submissionId);
                }
            });
             document.getElementById('manual-grading-container').addEventListener('click', saveManualGrade);
             document.getElementById('grading-back-button').addEventListener('click', () => viewResults(currentExamId));


            // Chat
            document.getElementById('chat-tab').addEventListener('click', openChat);
            document.getElementById('chat-close-button').addEventListener('click', closeChat);
            document.getElementById('send-chat-button').addEventListener('click', sendStudentMessage);
            document.getElementById('chat-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendStudentMessage();
            });
           
            // Teacher Chat
            document.getElementById('teacher-chat-back-button').addEventListener('click', closeTeacherChat);
            document.getElementById('teacher-send-reply-button').addEventListener('click', sendTeacherReply);
            document.getElementById('teacher-chat-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendTeacherReply();
            });
            document.getElementById('send-announcement-button').addEventListener('click', sendAnnouncement);
            document.getElementById('announcement-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendAnnouncement();
            });

            // Textarea auto-expand
            document.addEventListener('input', (e) => {
                if (e.target.tagName.toLowerCase() === 'textarea') {
                    e.target.style.height = 'auto';
                    e.target.style.height = (e.target.scrollHeight) + 'px';
                }
            }, false);
        });

    </script>
</body>
</html>
