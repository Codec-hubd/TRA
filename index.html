<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Exam Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .view-hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Auth View Container -->
        <div id="auth-view">
            <!-- Login Form -->
            <div id="login-form">
                <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto mt-20">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2 text-center">Login</h1>
                    <p class="text-gray-500 mb-8 text-center">Welcome back to the Exam Platform.</p>
                    <input type="email" id="login-email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <p id="login-error" class="text-red-500 text-sm text-center h-5 mb-2"></p>
                    <button id="login-button" onclick="handleLogin()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-md">Login</button>
                    <p class="text-center text-sm text-gray-600 mt-4">
                        Don't have an account? <a href="javascript:void(0)" onclick="toggleAuthView('signup')" class="font-medium text-blue-600 hover:text-blue-500">Sign Up</a>
                    </p>
                </div>
            </div>
            <!-- Signup Form -->
            <div id="signup-form" class="view-hidden">
                <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto mt-20">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2 text-center">Create Account</h1>
                    <p class="text-gray-500 mb-8 text-center">Join the platform to get started.</p>
                    <input type="email" id="signup-email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    <p id="signup-error" class="text-red-500 text-sm text-center h-5 mb-2"></p>
                    <button id="signup-button" onclick="handleSignup()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-md">Sign Up</button>
                    <p class="text-center text-sm text-gray-600 mt-4">
                        Already have an account? <a href="javascript:void(0)" onclick="toggleAuthView('login')" class="font-medium text-blue-600 hover:text-blue-500">Login</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- App Dashboard View (Post-Login) -->
        <div id="app-dashboard-view" class="view-hidden">
            <header class="flex justify-between items-center mb-8 bg-white p-4 rounded-2xl shadow-md">
                <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                <button onclick="logout()" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-600 transition shadow">Logout</button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Side: Create & Join -->
                <div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Join an Exam</h3>
                        <input type="text" id="student-name" placeholder="Enter Your Full Name" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <input type="text" id="exam-code-input" placeholder="Enter 6-Digit Exam Code" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <button onclick="joinExam()" class="w-full bg-gray-700 text-white font-semibold py-3 rounded-lg hover:bg-gray-800 transition-transform transform hover:scale-105 shadow-md">Start Exam</button>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Create an Exam</h3>
                        <p class="text-gray-600 mb-4">Design and share your own secure exams.</p>
                        <button onclick="showExamEditor()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                            Create New Exam
                        </button>
                    </div>
                </div>

                <!-- Right Side: My Exams -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">My Created Exams</h3>
                    <div id="exam-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Exam cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Exam Editor View -->
        <div id="exam-editor-view" class="view-hidden bg-white p-8 rounded-2xl shadow-lg">
            <h2 class="text-3xl font-bold mb-6 text-gray-800" id="editor-heading">Create New Exam</h2>
            <input type="text" id="exam-title" placeholder="Enter Exam Title" class="w-full text-2xl p-3 border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none rounded-t-lg mb-6 transition">
            <div class="flex items-center mb-8">
                 <label for="time-limit" class="mr-4 text-lg font-medium text-gray-700">Time Limit (minutes):</label>
                 <input type="number" id="time-limit" value="60" min="1" class="w-32 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>

            <div id="questions-container" class="space-y-6"></div>
            
            <div class="mt-8 border-t pt-6 flex items-center gap-4">
                 <span class="font-medium">Add Question:</span>
                 <button onclick="addQuestion('mcq')" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition shadow">Multiple Choice</button>
                 <button onclick="addQuestion('short')" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition shadow">Short Answer</button>
                 <button onclick="addQuestion('long')" class="bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-600 transition shadow">Long Answer</button>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button onclick="showView('app-dashboard-view')" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button onclick="saveExam()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 shadow-lg">Save Exam</button>
            </div>
        </div>
        
        <!-- Exam Taking View -->
        <div id="exam-taking-view" class="view-hidden">
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-6">
                    <div>
                        <h2 id="student-exam-title" class="text-3xl font-bold text-gray-800"></h2>
                        <p id="student-name-display" class="text-gray-600 text-lg"></p>
                    </div>
                    <div id="timer" class="text-2xl font-bold text-red-500 bg-red-100 px-4 py-2 rounded-lg mt-4 sm:mt-0"></div>
                </div>
                <div id="student-questions-container" class="space-y-8"></div>
                <div class="mt-8 flex justify-end border-t pt-6">
                    <button onclick="submitExam()" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 shadow-lg">Submit Exam</button>
                </div>
            </div>
        </div>

        <!-- Student Results View -->
        <div id="results-view" class="view-hidden">
             <div class="bg-white p-8 rounded-2xl shadow-lg max-w-4xl mx-auto mt-10">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Exam Results</h2>
                <p id="results-summary" class="text-xl text-center text-gray-600 mb-8 font-medium"></p>
                <div id="results-loader" class="view-hidden"><div class="loader"></div><p class="text-center text-gray-600">AI is grading your open-ended answers...</p></div>
                <div id="results-details-container" class="space-y-6">
                    <!-- Detailed results will be shown here -->
                </div>
                <div class="text-center mt-8">
                    <button onclick="showView('app-dashboard-view')" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow">Back to Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Teacher Results View -->
        <div id="teacher-results-view" class="view-hidden">
             <div class="bg-white p-8 rounded-2xl shadow-lg max-w-4xl mx-auto mt-10">
                <h2 id="teacher-results-heading" class="text-3xl font-bold text-gray-800 mb-6">Submissions</h2>
                <div id="submission-list" class="space-y-4">
                    <!-- Submission list will be shown here -->
                </div>
                <div class="text-center mt-8">
                    <button onclick="showView('app-dashboard-view')" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-400 transition">Back to Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWrHiR-IDa9RVAybVJ-UVEn5Hx9_qBWX4",
            authDomain: "exam-5e0cd.firebaseapp.com",
            projectId: "exam-5e0cd",
            storageBucket: "exam-5e0cd.appspot.com",
            messagingSenderId: "903148128941",
            appId: "1:903148128941:web:530b620c3e91dddec19424"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentExamId = null;
        let examTimerInterval = null;

        // --- UI Navigation ---
        window.showView = (viewId) => {
            document.querySelectorAll('#app > div').forEach(div => div.classList.add('view-hidden'));
            document.getElementById(viewId).classList.remove('view-hidden');
        };

        window.toggleAuthView = (formToShow) => {
            if (formToShow === 'signup') {
                document.getElementById('login-form').classList.add('view-hidden');
                document.getElementById('signup-form').classList.remove('view-hidden');
            } else {
                document.getElementById('login-form').classList.remove('view-hidden');
                document.getElementById('signup-form').classList.add('view-hidden');
            }
        };
        
        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                showView('app-dashboard-view');
                loadExams();
            } else {
                currentUser = null;
                showView('auth-view');
                toggleAuthView('login');
            }
        });

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const buttonEl = document.getElementById('login-button');

            errorEl.textContent = '';
            if (!email || !password) {
                errorEl.textContent = "Please enter email and password.";
                return;
            }

            buttonEl.disabled = true;
            buttonEl.textContent = 'Processing...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = `Login failed: ${error.message.replace('Firebase: ','')}`;
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = 'Login';
            }
        };

        window.handleSignup = async () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');
            const buttonEl = document.getElementById('signup-button');

            errorEl.textContent = '';
            if (!email || !password) {
                errorEl.textContent = "Please enter email and password.";
                return;
            }
            if (password.length < 6) {
                errorEl.textContent = "Password should be at least 6 characters.";
                return;
            }

            buttonEl.disabled = true;
            buttonEl.textContent = 'Processing...';

            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = `Signup failed: ${error.message.replace('Firebase: ','')}`;
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = 'Sign Up';
            }
        };
        
        window.logout = () => {
            signOut(auth);
            localStorage.clear();
            if(examTimerInterval) clearInterval(examTimerInterval);
        };

        // --- Main Dashboard ---
        async function loadExams() {
            if (!currentUser) return;
            const q = query(collection(db, "exams"), where("creatorId", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            const examList = document.getElementById('exam-list');
            examList.innerHTML = '';
            if(querySnapshot.empty){
                examList.innerHTML = `<p class="text-gray-500">You haven't created any exams yet.</p>`;
                return;
            }
            querySnapshot.forEach((doc) => {
                const exam = doc.data();
                const examCard = `
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-gray-800">${exam.title}</h4>
                            <p class="text-sm text-gray-600">Code: <span class="font-mono bg-gray-300 text-gray-800 px-2 py-0.5 rounded">${doc.id}</span></p>
                        </div>
                        <div class="flex space-x-2">
                           <button onclick="editExam('${doc.id}')" class="bg-yellow-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-yellow-600 transition text-sm">Edit</button>
                           <button onclick="viewResults('${doc.id}')" class="bg-teal-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-teal-600 transition text-sm">Results</button>
                        </div>
                    </div>`;
                examList.innerHTML += examCard;
            });
        }
        
        window.showExamEditor = async (examId = null) => {
            currentExamId = examId;
            document.getElementById('exam-title').value = '';
            document.getElementById('time-limit').value = 60;
            document.getElementById('questions-container').innerHTML = '';
            const heading = document.getElementById('editor-heading');
            questionIdCounter = 0;

            if (examId) {
                heading.innerText = 'Edit Exam';
                const docRef = doc(db, "exams", examId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const exam = docSnap.data();
                    document.getElementById('exam-title').value = exam.title;
                    document.getElementById('time-limit').value = exam.timeLimit || 60;
                    exam.questions.forEach((q) => addQuestion(q.type, q));
                }
            } else {
                 heading.innerText = 'Create New Exam';
            }
            showView('exam-editor-view');
        };

        window.editExam = (examId) => showExamEditor(examId);

        // --- Exam Editor ---
        let questionIdCounter = 0;
        function generateExamCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        window.addQuestion = (type, data = null) => {
            const container = document.getElementById('questions-container');
            const questionId = `q-${questionIdCounter++}`;
            const questionIndex = container.children.length + 1;
            let questionHTML = `
                <div id="${questionId}" class="p-6 border rounded-xl bg-gray-50 relative" data-type="${type}">
                    <button onclick="document.getElementById('${questionId}').remove()" class="absolute top-3 right-3 text-red-500 hover:text-red-700 font-bold p-1 rounded-full">&times;</button>
                    <div class="flex justify-between items-center mb-4">
                        <label class="block text-lg font-semibold text-gray-700">Question ${questionIndex}</label>
                        <div class="flex items-center gap-2">
                            <label class="font-medium text-gray-700">Points:</label>
                            <input type="number" value="${data ? data.points : 10}" min="1" class="w-20 p-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <textarea class="w-full p-2 border border-gray-300 rounded-lg mb-4 text-lg focus:ring-2 focus:ring-blue-400" placeholder="Enter question text...">${data ? data.text : ''}</textarea>`;

            switch (type) {
                case 'mcq':
                    questionHTML += '<div class="space-y-2 options-container">';
                    const options = data ? data.options : ['', '', '', ''];
                    options.forEach((opt, i) => {
                        questionHTML += `
                            <div class="flex items-center">
                                <input type="radio" name="correct-${questionId}" value="${i}" class="mr-3 h-5 w-5 accent-blue-600" ${data && data.correctAnswer == i ? 'checked' : ''}>
                                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-400" placeholder="Option ${i+1}" value="${opt}">
                            </div>`;
                    });
                    questionHTML += '</div>';
                    break;
                case 'short': case 'long':
                     questionHTML += `<div class="p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-r-lg text-sm">This open-ended question will be graded by AI.</div>`;
                    break;
            }
            questionHTML += '</div>';
            container.insertAdjacentHTML('beforeend', questionHTML);
        };
        
        window.saveExam = async () => {
            const title = document.getElementById('exam-title').value;
            const timeLimit = parseInt(document.getElementById('time-limit').value, 10);
            if (!title) { alert("Please enter an exam title."); return; }
            
            const questions = [];
            document.querySelectorAll('#questions-container > div').forEach(qDiv => {
                const question = {
                    type: qDiv.dataset.type,
                    text: qDiv.querySelector('textarea').value,
                    points: parseInt(qDiv.querySelector('input[type="number"]').value, 10) || 10
                };
                if (question.type === 'mcq') {
                    question.options = Array.from(qDiv.querySelectorAll('.options-container input[type="text"]')).map(opt => opt.value);
                    const correctRadio = qDiv.querySelector('input[type="radio"]:checked');
                    question.correctAnswer = correctRadio ? parseInt(correctRadio.value, 10) : -1;
                }
                questions.push(question);
            });

            if(questions.length === 0){ alert("Please add at least one question."); return; }

            const examData = { title, timeLimit, questions, creatorId: currentUser.uid };
            if (currentExamId) {
                await setDoc(doc(db, "exams", currentExamId), examData);
            } else {
                const newExamCode = generateExamCode();
                await setDoc(doc(db, "exams", newExamCode), examData);
            }
            showView('app-dashboard-view');
            loadExams();
        };

        // --- Student Flow ---
        window.joinExam = async () => {
            const examCode = document.getElementById('exam-code-input').value.trim().toUpperCase();
            const studentName = document.getElementById('student-name').value.trim();
            if (!examCode || !studentName) { alert("Please enter your name and an exam code."); return; }

            const docRef = doc(db, "exams", examCode);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                localStorage.setItem('currentExamCode', examCode);
                localStorage.setItem('currentStudentName', studentName);
                const exam = docSnap.data();
                localStorage.setItem('currentExamData', JSON.stringify(exam));

                document.getElementById('student-exam-title').innerText = exam.title;
                document.getElementById('student-name-display').innerText = `Student: ${studentName}`;
                
                const questionsContainer = document.getElementById('student-questions-container');
                questionsContainer.innerHTML = '';
                exam.questions.forEach((q, index) => {
                    let questionHTML = `<div class="p-4 rounded-lg bg-gray-50" data-index="${index}" data-type="${q.type}"><p class="text-xl font-semibold mb-4 text-gray-800">${index + 1}. ${q.text} <span class="text-base font-normal text-gray-500">(${q.points} points)</span></p>`;
                    if (q.type === 'mcq') {
                        questionHTML += `<div class="space-y-3">`;
                        q.options.forEach((opt, i) => {
                            questionHTML += `<label class="flex items-center p-3 border rounded-lg hover:bg-blue-50 cursor-pointer"><input type="radio" name="answer-${index}" value="${i}" class="h-5 w-5 mr-4 accent-blue-600"><span class="text-gray-700">${opt}</span></label>`;
                        });
                        questionHTML += `</div>`;
                    } else if (q.type === 'short') {
                        questionHTML += `<input type="text" placeholder="Your answer..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">`;
                    } else if (q.type === 'long') {
                         questionHTML += `<textarea rows="5" placeholder="Your detailed answer..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>`;
                    }
                    questionHTML += `</div>`;
                    questionsContainer.innerHTML += questionHTML;
                });
                startTimer(exam.timeLimit);
                showView('exam-taking-view');
            } else {
                alert("Invalid exam code.");
            }
        };

        function startTimer(minutes) {
            let seconds = minutes * 60;
            const timerEl = document.getElementById('timer');
            if (examTimerInterval) clearInterval(examTimerInterval);
            examTimerInterval = setInterval(() => {
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                timerEl.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                seconds--;
                if (seconds < 0) {
                    clearInterval(examTimerInterval);
                    submitExam();
                }
            }, 1000);
        }

        async function evaluateWithAI(question, answer) {
            const pipedreamUrl = "https://eoepvhnq3ujiz2g.m.pipedream.net";
            
            try {
                const response = await fetch(pipedreamUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, answer })
                });

                const responseText = await response.text();
                console.log("Received raw text from Pipedream:", responseText);

                if (!response.ok) {
                    console.error("Pipedream workflow returned an error:", response.status, response.statusText, responseText);
                    if (responseText.includes("Success!")) {
                         console.error("CRITICAL ERROR: Pipedream is returning its default success message. You MUST configure the final step of your Pipedream workflow to return the AI's response data. Add a 'Return HTTP Response' step at the end of your workflow, and for the 'Body', select the result of the AI step (e.g., 'steps.create_message.$return_value').");
                         throw new Error("Pipedream workflow is not configured to return AI data.");
                    }
                    throw new Error("Failed to get a valid response from the grading service.");
                }
                
                // This is the updated, robust JSON extraction logic.
                // It handles cases where the AI adds conversational text around the JSON object.
                const jsonMatch = responseText.match(/\{.*\}/s);
                if (jsonMatch && jsonMatch[0]) {
                    const jsonString = jsonMatch[0];
                    console.log("Found and extracted JSON string:", jsonString);
                    try {
                        return JSON.parse(jsonString);
                    } catch (innerParseError) {
                        console.error("Failed to parse the extracted JSON string:", innerParseError);
                        throw new Error("Extracted text was not valid JSON.");
                    }
                } else {
                    // This error will be thrown if the response contains no JSON at all.
                    console.error("No JSON object found in the response from Pipedream. Raw response:", responseText);
                    throw new Error("No JSON object found in the AI response.");
                }

            } catch (error) {
                console.error("The AI grading function failed:", error);
                return { score: 0, feedback: "AI grading failed. This answer has been marked as incorrect." };
            }
        }
        
        window.submitExam = async () => {
            if(examTimerInterval) clearInterval(examTimerInterval);
            showView('results-view');
            document.getElementById('results-loader').classList.remove('view-hidden');
            document.getElementById('results-details-container').innerHTML = '';
            document.getElementById('results-summary').innerText = '';

            const examData = JSON.parse(localStorage.getItem('currentExamData'));
            const studentAnswers = [];
            const studentName = localStorage.getItem('currentStudentName');

            document.querySelectorAll('#student-questions-container > div').forEach((qDiv) => {
                const type = qDiv.dataset.type; let answer;
                if(type === 'mcq') { const checkedRadio = qDiv.querySelector('input[type="radio"]:checked'); answer = checkedRadio ? parseInt(checkedRadio.value, 10) : null; } 
                else if (type === 'short') { answer = qDiv.querySelector('input').value; } 
                else if (type === 'long') { answer = qDiv.querySelector('textarea').value; }
                studentAnswers.push(answer);
            });

            const gradingPromises = examData.questions.map((question, i) => {
                const studentAnswer = studentAnswers[i];
                if (question.type === 'mcq') {
                    const score = (studentAnswer === question.correctAnswer) ? 1.0 : 0.0;
                    return Promise.resolve({
                        score: score,
                        feedback: score === 1.0 ? 'Correct' : 'Incorrect',
                        question: question,
                        studentAnswer: studentAnswer
                    });
                } else {
                    return evaluateWithAI(question.text, studentAnswer || "").then(aiResult => ({
                        score: aiResult.score,
                        feedback: aiResult.feedback,
                        question: question,
                        studentAnswer: studentAnswer
                    }));
                }
            });

            const allResults = await Promise.all(gradingPromises);

            let earnedScore = 0;
            let totalPossibleScore = 0;
            const resultsDetailsContainer = document.getElementById('results-details-container');
            
            allResults.forEach((result, i) => {
                const question = result.question;
                const studentAnswer = result.studentAnswer;
                const points = question.points || 10;
                totalPossibleScore += points;
                earnedScore += result.score * points;

                let resultColor = 'red';
                if (result.score === 1.0) {
                    resultColor = 'green';
                } else if (result.score > 0 && result.score < 1.0) {
                    resultColor = 'yellow';
                }
                
                let answerDisplay = '';
                if (question.type === 'mcq') {
                    const studentChoice = studentAnswer !== null ? question.options[studentAnswer] : "No answer";
                    const correctChoice = question.options[question.correctAnswer];
                    answerDisplay = `<p class="mt-2">Your answer: <span class="font-medium ${result.score === 1.0 ? 'text-green-700' : 'text-red-700'}">${studentChoice}</span></p><p>Correct answer: <span class="font-medium text-green-700">${correctChoice}</span></p>`;
                } else {
                    answerDisplay = `<p class="mt-2">Your answer: <span class="font-medium text-gray-800">${studentAnswer || "No answer"}</span></p><p class="mt-2 p-2 bg-gray-100 rounded">AI Feedback: <span class="font-medium text-gray-700">${result.feedback}</span></p>`;
                }

                resultsDetailsContainer.innerHTML += `<div class="p-4 border-l-4 border-${resultColor}-500 bg-${resultColor}-50 rounded-r-lg"><p class="font-semibold text-gray-800">${i + 1}. ${question.text} <span class="font-normal text-gray-600">(${(result.score * points).toFixed(1)}/${points} points)</span></p>${answerDisplay}</div>`;
            });

            const percentage = totalPossibleScore > 0 ? ((earnedScore / totalPossibleScore) * 100).toFixed(1) : 0;

            document.getElementById('results-loader').classList.add('view-hidden');
            document.getElementById('results-summary').innerText = `You scored ${earnedScore.toFixed(1)} out of ${totalPossibleScore} (${percentage}%)`;

            const examCode = localStorage.getItem('currentExamCode');
            const submissionData = { studentName, score: earnedScore, totalScore: totalPossibleScore, percentage, timestamp: serverTimestamp() };
            const submissionsCol = collection(db, "exams", examCode, "submissions");
            await addDoc(submissionsCol, submissionData);
        };
        
        window.viewResults = async (examId) => {
            const examRef = doc(db, "exams", examId);
            const examSnap = await getDoc(examRef);
            const examTitle = examSnap.exists() ? examSnap.data().title : "Results";
            
            document.getElementById('teacher-results-heading').innerText = `Submissions for: ${examTitle}`;
            showView('teacher-results-view');
            const submissionListEl = document.getElementById('submission-list');
            submissionListEl.innerHTML = '<div class="loader"></div>';

            const submissionsCol = collection(db, "exams", examId, "submissions");
            const snapshot = await getDocs(submissionsCol);

            if (snapshot.empty) {
                submissionListEl.innerHTML = '<p class="text-gray-500 text-center">No submissions have been made for this exam yet.</p>';
                return;
            }

            submissionListEl.innerHTML = '';
            snapshot.forEach(doc => {
                const sub = doc.data();
                const submissionCard = `
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-lg text-gray-800">${sub.studentName}</p>
                            <p class="font-semibold text-blue-600">Score: ${sub.score.toFixed(1)} / ${sub.totalScore} (${sub.percentage}%)</p>
                        </div>
                        <p class="text-sm text-gray-500">Submitted on: ${new Date(sub.timestamp?.toDate()).toLocaleString()}</p>
                    </div>
                `;
                submissionListEl.innerHTML += submissionCard;
            });
        };

    </script>
</body>
</html>

